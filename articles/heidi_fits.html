<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="heidi">
<title>heidi_fits • heidi</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="heidi_fits">
<meta property="og:description" content="heidi">
<meta property="og:image" content="http://victornavarro.org/heidi/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">heidi</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/heidi_basics.html">heidi_basics</a>
    <a class="dropdown-item" href="../articles/heidi_fits.html">heidi_fits</a>
    <a class="dropdown-item" href="../articles/heidi_math.html">heidi_math</a>
    <a class="dropdown-item" href="../articles/heidi_similarity.html">heidi_similarity</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/victor-navarro/heidi/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="heidi_fits_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>heidi_fits</h1>
                        <h4 data-toc-skip class="author">Victor Navarro</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/victor-navarro/heidi/blob/HEAD/vignettes/heidi_fits.Rmd" class="external-link"><code>vignettes/heidi_fits.Rmd</code></a></small>
      <div class="d-none name"><code>heidi_fits.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/victor-navarro/heidi" class="external-link">heidi</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">pati</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="fitting-the-model-to-empirical-data">Fitting the model to empirical data<a class="anchor" aria-label="anchor" href="#fitting-the-model-to-empirical-data"></a>
</h2>
<p>We now fit the model to some empirical data (Patitucci et al., 2016, Experiment 1). This will involve writing a function that produces model responses organized as the empirical data, and using that function for maximum likelihood estimation (MLE). We begin with a short overview of the data, then move to the model function, and finally fit the model.</p>
<div class="section level3">
<h3 id="the-data">The data<a class="anchor" aria-label="anchor" href="#the-data"></a>
</h3>
<p>The data (<code>pati</code>) contains the responses (lever presses or lp, and nose pokes or np) for 32 subjects (rats) across 6 blocks of training (2 sessions per block). The animals were trained to associate each of two levers to one of two unconditioned stimuli (pellets or sucrose). Let’s take a look at it.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">pati</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 768</span></span>
<span><span class="co">#&gt; Columns: 6</span></span>
<span><span class="co">#&gt; $ subject  <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…</span></span>
<span><span class="co">#&gt; $ block    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3…</span></span>
<span><span class="co">#&gt; $ lever    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> L, L, L, L, L, L, R, R, R, R, R, R, L, L, L, L, L, L, R, R, R…</span></span>
<span><span class="co">#&gt; $ us       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "P", "P", "P", "P", "P", "P", "S", "S", "S", "S", "S", "S", "…</span></span>
<span><span class="co">#&gt; $ response <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> lp, lp, lp, lp, lp, lp, lp, lp, lp, lp, lp, lp, np, np, np, n…</span></span>
<span><span class="co">#&gt; $ rpert    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.9000, 1.5500, 3.3500, 4.1500, 4.6500, 4.3250, 0.4000, 0.162…</span></span>
<span><span class="va">pati</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">block</span>, y <span class="op">=</span> <span class="va">rpert</span>, colour <span class="op">=</span> <span class="va">us</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html" class="external-link">interaction</a></span><span class="op">(</span><span class="va">us</span>, <span class="va">subject</span><span class="op">)</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_summary.html" class="external-link">stat_summary</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">'line'</span>, fun <span class="op">=</span> <span class="st">'mean'</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Block"</span>, y <span class="op">=</span> <span class="st">"Responses per trial"</span>, colour <span class="op">=</span> <span class="st">"US"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="op">~</span><span class="va">response</span><span class="op">)</span></span></code></pre></div>
<p><img src="heidi_fits_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<p>The thicker lines are group averages; the rest are individual subjects. We ignore the specific mapping between levers and USs here, because that was counterbalanced across subjects. However, the counterbalancing will end up being relevant (see ahead).</p>
</div>
<div class="section level3">
<h3 id="writing-the-model-function">Writing the model function<a class="anchor" aria-label="anchor" href="#writing-the-model-function"></a>
</h3>
<p>The biggest hurdle in fitting the model to empirical data is to write a function that, given a vector of parameters and model arguments, generates responses that are organized as the empirical data. Let’s begin by summarizing the group data first, so we know what to aim for.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pati_summ</span> <span class="op">&lt;-</span> <span class="va">pati</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">block</span>, <span class="va">us</span>, <span class="va">response</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>rpert <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">rpert</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pati_summ</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 4</span></span></span>
<span><span class="co">#&gt;   block us    response rpert</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1 P     lp       0.820</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     1 P     np       3.41 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     1 S     lp       0.561</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     1 S     np       3.28 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     2 P     lp       1.57 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>     2 P     np       3.51</span></span></code></pre></div>
<p>We now prepare the arguments for the model function (as you would pass to <code>run_heidi</code>). To achieve this, we will use <code>make_heidi_args</code>, a function that requires three other bits: 1) a design data.frame, 2) a table with parameters, and 3) a list with simulation options. Note that these arguments are fixed during the optimization process, which means that the training routine within each iteration of the numerical optimization is always the same.</p>
<p>This is no minor issue, because the HeiDI is sensitive to order effects. Hence, it is important that the arguments we prepare here reflect the behavior of the model after an “general” experimental procedure, and not the quirks of an unfortunate run of tials. Here, we simply address this issue by running several iterations of the model (with random trial orders) and average all models before evaluating the likelihood of the parameters.</p>
<p>So what do we have to design? The experiment presented in Patittuci et al. (2016) was fairly simple, and it can be reduced to the presentations of two levers, each followed by a different appetitive outcome. Here, we will assume that the two outcomes are independent from each other. We will also take some liberties with the number of trials we specify in order to reduce computing time.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#The design data.frame</span></span>
<span><span class="va">des_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CB1"</span>, <span class="st">"CB2"</span><span class="op">)</span>,</span>
<span>                     training <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"12L&gt;(Pellet)/12R&gt;(Sucrose)"</span>, <span class="st">"12L&gt;(Sucrose)/12R&gt;(Pellet)"</span><span class="op">)</span>,</span>
<span>                     rand_train <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#The parameters</span></span>
<span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/heidi_helpers.html">get_params</a></span><span class="op">(</span><span class="va">des_df</span><span class="op">)</span> <span class="co">#the actual parameter values don't matter, as our function will re-write them inside the optimizer call</span></span>
<span><span class="co">#The options</span></span>
<span><span class="va">opts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_heidi_opts.html">get_heidi_opts</a></span><span class="op">(</span>iterations <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#The arguments</span></span>
<span><span class="va">my_mod_args</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_heidi_args.html">make_heidi_args</a></span><span class="op">(</span>design <span class="op">=</span> <span class="fu"><a href="../reference/parse_design.html">parse_design</a></span><span class="op">(</span><span class="va">des_df</span><span class="op">)</span>, pars <span class="op">=</span> <span class="va">pars</span>, opts <span class="op">=</span> <span class="va">opts</span><span class="op">)</span></span></code></pre></div>
<p>Note we specified two counterbalancings as groups. It is very important that we reproduce the counterbalancings in the data we are trying to fit as close as possible. Otherwise, the optimization process might latch onto experimentally-irrelevant variables. For example, it can be seen in <code>pati</code> that there was more lever pressing whenever a lever was paired with pellets. If we didn’t counterbalance the identities of the levers and USs, the optimization might result into one of the levers being less salient than the other.</p>
<p>We can now begin to write the model function. First, it would be a good idea to see what <code>run_heidi</code> returns if run with the arguments above.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_heidi.html">run_heidi</a></span><span class="op">(</span>args <span class="op">=</span> <span class="va">my_mod_args</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">mod_res</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 4</span></span>
<span><span class="co">#&gt;  $ vs  : tibble [1,152 × 8] (S3: tbl_df/tbl/data.frame)</span></span>
<span><span class="co">#&gt;   ..$ group     : Factor w/ 2 levels "CB1","CB2": 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ trial     : int [1:1152] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ trial_type: Factor w/ 4 levels "L&gt;(Pellet)","L&gt;(Sucrose)",..: 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ phase     : Factor w/ 1 level "training": 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ s1        : Factor w/ 4 levels "L","Pellet","R",..: 1 1 1 2 2 2 3 3 3 4 ...</span></span>
<span><span class="co">#&gt;   ..$ s2        : Factor w/ 4 levels "L","Pellet","R",..: 2 3 4 1 3 4 1 2 4 1 ...</span></span>
<span><span class="co">#&gt;   ..$ block_size: num [1:1152] 2 2 2 2 2 2 2 2 2 2 ...</span></span>
<span><span class="co">#&gt;   ..$ value     : num [1:1152] 0.04 0 0 0.04 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ acts: tibble [768 × 9] (S3: tbl_df/tbl/data.frame)</span></span>
<span><span class="co">#&gt;   ..$ group     : Factor w/ 2 levels "CB1","CB2": 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ trial     : int [1:768] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ phase     : Factor w/ 1 level "training": 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ trial_type: Factor w/ 4 levels "L&gt;(Pellet)","L&gt;(Sucrose)",..: 1 1 1 1 1 1 1 1 4 4 ...</span></span>
<span><span class="co">#&gt;   ..$ act_type  : Factor w/ 2 levels "chain","comb": 1 1 1 1 2 2 2 2 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ s1        : Factor w/ 2 levels "L","R": 1 1 1 1 1 1 1 1 2 2 ...</span></span>
<span><span class="co">#&gt;   ..$ s2        : Factor w/ 4 levels "L","Pellet","R",..: 1 2 3 4 1 2 3 4 1 2 ...</span></span>
<span><span class="co">#&gt;   ..$ block_size: num [1:768] 2 2 2 2 2 2 2 2 2 2 ...</span></span>
<span><span class="co">#&gt;   ..$ value     : num [1:768] 0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ rs  : tibble [1,536 × 8] (S3: tbl_df/tbl/data.frame)</span></span>
<span><span class="co">#&gt;   ..$ group     : Factor w/ 2 levels "CB1","CB2": 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ trial     : int [1:1536] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ phase     : Factor w/ 1 level "training": 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ trial_type: Factor w/ 4 levels "L&gt;(Pellet)","L&gt;(Sucrose)",..: 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ s1        : Factor w/ 4 levels "L","Pellet","R",..: 1 1 1 1 2 2 2 2 3 3 ...</span></span>
<span><span class="co">#&gt;   ..$ s2        : Factor w/ 4 levels "L","Pellet","R",..: 1 2 3 4 1 2 3 4 1 2 ...</span></span>
<span><span class="co">#&gt;   ..$ block_size: num [1:1536] 2 2 2 2 2 2 2 2 2 2 ...</span></span>
<span><span class="co">#&gt;   ..$ value     : num [1:1536] 0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ as  : tibble [384 × 7] (S3: tbl_df/tbl/data.frame)</span></span>
<span><span class="co">#&gt;   ..$ group     : Factor w/ 2 levels "CB1","CB2": 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ trial     : int [1:384] 1 1 1 1 1 1 1 1 2 2 ...</span></span>
<span><span class="co">#&gt;   ..$ phase     : Factor w/ 1 level "training": 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ trial_type: Factor w/ 4 levels "L&gt;(Pellet)","L&gt;(Sucrose)",..: 1 1 1 1 4 4 4 4 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ s1        : Factor w/ 4 levels "L","Pellet","R",..: 1 2 3 4 1 2 3 4 1 2 ...</span></span>
<span><span class="co">#&gt;   ..$ block_size: num [1:384] 2 2 2 2 2 2 2 2 2 2 ...</span></span>
<span><span class="co">#&gt;   ..$ value     : num [1:384] 0.2 0 0 0 0 0 0.2 0 0.2 0 ...</span></span></code></pre></div>
<p>Although the <code>run_heidi</code> function returns a list with 4 tibbles, we only care about one of them: <code>rs</code> (the model responses). With that in hand, we can write our model function.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_model_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pars</span>, <span class="va">model_args</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#manipulating pars</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">model_args</span><span class="op">$</span><span class="va">stim_alphas</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">model_args</span><span class="op">$</span><span class="va">stim_alphas</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span></span>
<span>  <span class="co">#running the model and selecting rs</span></span>
<span>  <span class="va">mod_res</span> <span class="op">=</span> <span class="fu"><a href="../reference/run_heidi.html">run_heidi</a></span><span class="op">(</span>args <span class="op">=</span> <span class="va">model_args</span><span class="op">)</span><span class="op">$</span><span class="va">rs</span></span>
<span>  <span class="co">#summarizing the model</span></span>
<span>  <span class="va">mod_res</span> <span class="op">=</span> <span class="va">mod_res</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">s2</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Pellet"</span>, <span class="st">"Sucrose"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>response <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">s1</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Pellet"</span>, <span class="st">"Sucrose"</span><span class="op">)</span>, <span class="st">"np"</span>, <span class="st">"lp"</span><span class="op">)</span>,</span>
<span>           block <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">trial</span><span class="op">/</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#note this filter below; we do not allow lever presses if the lever was not presented on the trial</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">response</span> <span class="op">==</span> <span class="st">"np"</span> <span class="op">|</span> <span class="op">(</span><span class="va">response</span> <span class="op">==</span> <span class="st">"lp"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="va">s1</span>, <span class="va">trial_type</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>us <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"Pellet"</span>, <span class="va">trial_type</span><span class="op">)</span>, <span class="st">"P"</span>, <span class="st">"S"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">us</span>, <span class="va">block</span>, <span class="va">response</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span>
<span>  <span class="va">mod_res</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s dissect the function above in its three parts.</p>
<ol style="list-style-type: decimal">
<li><p>We do some manipulation on the vector of parameters, naming them according to the stimulus names identified in the arguments (<code>names(model_args$stim_alphas[[1]])</code>). We do this because the function we use to simulate (i.e., the one called by <code>run_heidi</code>) requires a named vector to work, and some optimizers (looking at you optim) strip the names from the numerical vectors they are trying to optimize.</p></li>
<li><p>We run the model and immediately select the relevant information (rs).</p></li>
<li><p>Finally, we summarise the model responses, taking care of the different counterbalancings in the process. Within this step, we also filter all output nodes that are not related to expecting one of the USs (because the latest public version of the model is lagging behind the latest theoretical developments), we classify responses as being nosepokes (produced by the US) or lever presses (produced by the levers), and calculate the mean across blocks of trials.</p></li>
</ol>
<p>Let’s see the function in action.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">my_model_function</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">.2</span>, <span class="fl">.4</span>, <span class="fl">.3</span><span class="op">)</span>, model_args <span class="op">=</span> <span class="va">my_mod_args</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 24 × 4</span></span></span>
<span><span class="co">#&gt;    us    block response   value</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> P         1 lp       0.011<span style="text-decoration: underline;">4</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> P         1 np       0.002<span style="text-decoration: underline;">29</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> P         2 lp       0.038<span style="text-decoration: underline;">8</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> P         2 np       0.017<span style="text-decoration: underline;">2</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> P         3 lp       0.049<span style="text-decoration: underline;">2</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> P         3 np       0.033<span style="text-decoration: underline;">2</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> P         4 lp       0.054<span style="text-decoration: underline;">2</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> P         4 np       0.045<span style="text-decoration: underline;">6</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> P         5 lp       0.057<span style="text-decoration: underline;">0</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> P         5 np       0.054<span style="text-decoration: underline;">8</span> </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 14 more rows</span></span></span></code></pre></div>
<p>And just as a refresher, here’s the summarised empirical data.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pati_summ</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 24 × 4</span></span></span>
<span><span class="co">#&gt;    block us    response rpert</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1 P     lp       0.820</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1 P     np       3.41 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1 S     lp       0.561</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1 S     np       3.28 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     2 P     lp       1.57 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     2 P     np       3.51 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     2 S     lp       0.641</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     2 S     np       3.07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     3 P     lp       2.29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     3 P     np       3.07 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 14 more rows</span></span></span></code></pre></div>
<p>Do you notice anything odd about the ordering? The empirical data is sorted in a different way, but I said before that the order of the empirical data and model responses must match. I cannot emphasize this point enough: there is nothing within the fit function that checks or reorders the data for you. You are the sole responsible for making sure both of these pieces of data are in the same order.</p>
<p>Here, we will simply rewrite the model function so it matches the ordering of the empirical data. Notice the different order in the <code>group_by</code> line below.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_model_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pars</span>, <span class="va">model_args</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#manipulating pars</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">model_args</span><span class="op">$</span><span class="va">stim_alphas</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">model_args</span><span class="op">$</span><span class="va">stim_alphas</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span></span>
<span>  <span class="co">#running the model and selecting rs</span></span>
<span>  <span class="va">mod_res</span> <span class="op">=</span> <span class="fu"><a href="../reference/run_heidi.html">run_heidi</a></span><span class="op">(</span>args <span class="op">=</span> <span class="va">model_args</span><span class="op">)</span><span class="op">$</span><span class="va">rs</span></span>
<span>  <span class="co">#summarizing the model</span></span>
<span>  <span class="va">mod_res</span> <span class="op">=</span> <span class="va">mod_res</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">s2</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Pellet"</span>, <span class="st">"Sucrose"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>response <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">s1</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Pellet"</span>, <span class="st">"Sucrose"</span><span class="op">)</span>, <span class="st">"np"</span>, <span class="st">"lp"</span><span class="op">)</span>,</span>
<span>           block <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">trial</span><span class="op">/</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#note this filter below; we do not allow lever presses if the lever was not presented on the trial</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">response</span> <span class="op">==</span> <span class="st">"np"</span> <span class="op">|</span> <span class="op">(</span><span class="va">response</span> <span class="op">==</span> <span class="st">"lp"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="va">s1</span>, <span class="va">trial_type</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>us <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"Pellet"</span>, <span class="va">trial_type</span><span class="op">)</span>, <span class="st">"P"</span>, <span class="st">"S"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">block</span>, <span class="va">us</span>, <span class="va">response</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span>
<span>  <span class="va">mod_res</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="fu">my_model_function</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">.2</span>, <span class="fl">.4</span>, <span class="fl">.3</span><span class="op">)</span>, model_args <span class="op">=</span> <span class="va">my_mod_args</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 24</span></span>
<span><span class="co">#&gt; Columns: 4</span></span>
<span><span class="co">#&gt; $ block    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 6…</span></span>
<span><span class="co">#&gt; $ us       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "P", "P", "S", "S", "P", "P", "S", "S", "P", "P", "S", "S", "…</span></span>
<span><span class="co">#&gt; $ response <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "lp", "np", "lp", "np", "lp", "np", "lp", "np", "lp", "np", "…</span></span>
<span><span class="co">#&gt; $ value    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.011428571, 0.002285714, 0.009086538, 0.001362981, 0.0388438…</span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">pati_summ</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 24</span></span>
<span><span class="co">#&gt; Columns: 4</span></span>
<span><span class="co">#&gt; $ block    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 6…</span></span>
<span><span class="co">#&gt; $ us       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "P", "P", "S", "S", "P", "P", "S", "S", "P", "P", "S", "S", "…</span></span>
<span><span class="co">#&gt; $ response <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> lp, np, lp, np, lp, np, lp, np, lp, np, lp, np, lp, np, lp, n…</span></span>
<span><span class="co">#&gt; $ rpert    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.8195313, 3.4109375, 0.5609375, 3.2796875, 1.5738281, 3.5070…</span></span></code></pre></div>
<p>Much better! We are now ready to begin fitting the model.</p>
</div>
<div class="section level3">
<h3 id="fitting-the-model">Fitting the model<a class="anchor" aria-label="anchor" href="#fitting-the-model"></a>
</h3>
<p>We fit models using the <code>fit_heidi</code> function. This function requires 4 arguments:</p>
<ol style="list-style-type: decimal">
<li>The (empirical) data</li>
<li>A model function</li>
<li>The arguments with which to run the model function.</li>
<li>The optimizer options.</li>
</ol>
<p>We have done a great job taking care of the first three, so let’s tackle the last.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_optimizer_opts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_helpers.html">get_optimizer_opts</a></span><span class="op">(</span>optimizer <span class="op">=</span> <span class="st">"optim"</span>,</span>
<span>                                        stim_names <span class="op">=</span> <span class="va">pars</span><span class="op">$</span><span class="va">Stimulus</span>,</span>
<span>                                        family <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span>
<span><span class="va">my_optimizer_opts</span></span>
<span><span class="co">#&gt; $stim_names</span></span>
<span><span class="co">#&gt; [1] "L"       "R"       "Pellet"  "Sucrose"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $lower</span></span>
<span><span class="co">#&gt; [1] 1e-06 1e-06 1e-06 1e-06 1e-06</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $upper</span></span>
<span><span class="co">#&gt; [1]   0.999999   0.999999   0.999999   0.999999 100.000000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $optimizer</span></span>
<span><span class="co">#&gt; [1] "optim"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sample_pars</span></span>
<span><span class="co">#&gt; function () </span></span>
<span><span class="co">#&gt; c(stats::rbeta(npars, 10, 20), stats::rgamma(1, 2))</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x5555a91abd30&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: 0x5555a91aef20&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $family</span></span>
<span><span class="co">#&gt; [1] "linear"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $family_pars</span></span>
<span><span class="co">#&gt; [1] "scale"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $verbose</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $optim_options</span></span>
<span><span class="co">#&gt; $optim_options$method</span></span>
<span><span class="co">#&gt; [1] "L-BFGS-B"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $optim_options$control</span></span>
<span><span class="co">#&gt; $optim_options$control$trace</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
<p>The <code>get_optimizer_opts</code> function returns many things:</p>
<ol style="list-style-type: decimal">
<li>stim_names: The name of the stimuli for which to find salience parameters.</li>
<li>lower and upper: The lower and upper bounds for the parameter search. Consider shrinking these to speed up the process.</li>
<li>optimizer: The numerical optimization technique we wish to use during MLE estimation.</li>
<li>sample_pars: A function that samples parameters from set distributions.</li>
<li>family: The family distribution we assume for our model. In practice, what you request here will be used to determine the link function to transform model responses, and the likelihood function used in the objective function. The linear family here does nothing fancy to the model responses, and will estimate an extra parameter, scale, which scales the model responses into (roughly) the scale of the empirical data. When it comes to likelihood functions, this family will use the normal density of the data and model differences.</li>
<li>family_pars: The family-specific parameter being estimated alongside salience parameters.</li>
<li>verbose: Whether to print parameters and objective function values as we optimize.</li>
<li>optim_options: The optimizer-specific options that are used in the optimization call.</li>
</ol>
<p>You are free to modify these; just make sure the structure of the list returned by <code>get_optimizer_opts</code> remains the same. Here, I overwrite the trace argument passed to the optimizer.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_optimizer_opts</span><span class="op">$</span><span class="va">optim_options</span><span class="op">$</span><span class="va">control</span><span class="op">$</span><span class="va">trace</span> <span class="op">=</span> <span class="fl">0</span></span></code></pre></div>
<p>And with that, we can fit the model!</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">the_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_heidi.html">fit_heidi</a></span><span class="op">(</span><span class="va">pati_summ</span><span class="op">$</span><span class="va">rpert</span>,</span>
<span>                     model_function <span class="op">=</span> <span class="va">my_model_function</span>, model_args <span class="op">=</span> <span class="va">my_mod_args</span>,</span>
<span>                     optimizer_options <span class="op">=</span> <span class="va">my_optimizer_opts</span><span class="op">)</span></span></code></pre></div>
<p>The <code>fit_heidi</code> function returns a lot of information to track what we put in and what we got out. Regarding the latter, we can see the MLE parameters we obtained this time, and their negative log likelihood, given the data:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">the_fit</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"best_pars"</span>, <span class="st">"nloglik"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt; $best_pars</span></span>
<span><span class="co">#&gt;          L          R     Pellet    Sucrose      scale </span></span>
<span><span class="co">#&gt;  0.2505208  0.2505176  0.9999990  0.9999990 17.0694079 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nloglik</span></span>
<span><span class="co">#&gt; [1] 38.15569</span></span></code></pre></div>
<p>That’s good and all, but how well does a model run with those parameters “visually” fit the data? We can obtain the predictions from the model via the <code>fit_predict</code> function.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prediction</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_helpers.html">fit_predict</a></span><span class="op">(</span><span class="va">the_fit</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">block</span>, <span class="va">us</span>, <span class="va">response</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="va">data</span> <span class="op">=</span> <span class="va">the_fit</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="va">prediction</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="st">"prediction"</span> <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"prediction"</span>, <span class="st">"data"</span><span class="op">)</span>,</span>
<span>                        names_to <span class="op">=</span> <span class="st">"type"</span>,</span>
<span>                        values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">block</span>, y <span class="op">=</span> <span class="va">value</span>, colour <span class="op">=</span> <span class="va">us</span>, linetype <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">us</span><span class="op">~</span><span class="va">response</span><span class="op">)</span></span></code></pre></div>
<p><img src="heidi_fits_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
<p>This looks pretty good! Save from some blatant misfits, of course. Now you know everything you need to fit heidi to your empirical data. Go forth!</p>
<div class="section level4">
<h4 id="a-final-note">A final note<a class="anchor" aria-label="anchor" href="#a-final-note"></a>
</h4>
<p>This vignette was pre-generated, as I don’t want the user to fit the model at the time of installation. I will try to keep up with it as the package develops, but if you spot any inconsistencies, please drop me a line.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Victor Navarro.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
